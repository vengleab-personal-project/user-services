// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  user
  admin
  editor
}

enum OAuthProvider {
  google
  github
}

enum SubscriptionTier {
  free
  pro
  enterprise
}

enum SubscriptionStatus {
  active
  cancelled
  past_due
  trialing
  quota_exhausted
}

enum BillingCycle {
  monthly
  yearly
}

enum PlanType {
  monthly
  one_off
}

enum PolicyEffect {
  allow
  deny
}

enum Visibility {
  private
  public
  unlisted
}

enum FieldType {
  text
  number
  dropdown
  checkbox
  radio
  date
  file
}

enum UsageEventType {
  api_call
  form_created
  field_generated
  form_deleted
  ai_questions_generated
  custom
}

enum UsageCategory {
  api
  ai
  forms
  fields
  auth
  other
}

enum UsageUnits {
  requests
  tokens
  fields
  items
  operations
}

model User {
  id               String           @id @default(uuid())
  email            String           @unique
  name             String
  avatar           String?
  role             Role             @default(user)
  oauthProvider    OAuthProvider
  oauthId          String
  subscriptionTier SubscriptionTier @default(free)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  lastLoginAt      DateTime?
  metadata         Json?

  // Relations
  forms         Form[]
  sessions      Session[]
  subscriptions Subscription[]
  usageRecords  UsageRecord[]
  usageEvents   UsageEvent[]
  policies      Policy[]
  stats         UserStats?

  @@unique([oauthProvider, oauthId])
  @@index([email])
}

model UserStats {
  id           String   @id @default(uuid())
  userId       String   @unique
  formCount    Int      @default(0)
  fieldCount   Int      @default(0)
  totalApiCalls Int     @default(0)
  lastUpdated  DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Session {
  id               String   @id @default(uuid())
  userId           String
  tokenHash        String   @unique
  refreshTokenHash String?
  ipAddress        String?
  userAgent        String?
  device           String?
  browser          String?
  os               String?
  location         String?
  isActive         Boolean  @default(true)
  lastActivityAt   DateTime @default(now())
  expiresAt        DateTime
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([isActive])
}

model Policy {
  id          String        @id @default(uuid())
  name        String
  description String?
  resource    String // e.g., 'form', 'form:field', 'user', '*'
  action      String // e.g., 'read', 'write', 'delete', 'create', '*'
  effect      PolicyEffect
  conditions  Json? // PolicyConditions
  priority    Int          @default(0)
  userId      String?
  enabled     Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([resource, action])
  @@index([enabled])
}

model Form {
  id          String     @id @default(uuid())
  userId      String
  title       String
  description String?
  pages       Json // Page[]
  fields      Json // Field[]
  visibility  Visibility @default(private)
  version     Int        @default(1)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  metadata    Json?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([visibility])
}

model Subscription {
  id           String             @id @default(uuid())
  userId       String
  tier         SubscriptionTier
  planType     PlanType           @default(monthly)
  billingCycle BillingCycle?
  status       SubscriptionStatus @default(active)
  limits       Json // SubscriptionLimits
  quotaLimits  Json? // QuotaLimits
  quotaUsage   Json? // QuotaUsage
  billingInfo  Json? // BillingInfo
  startDate    DateTime
  endDate      DateTime?
  trialEndDate DateTime?
  cancelledAt  DateTime?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  metadata     Json?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model UsageRecord {
  id                    String              @id @default(uuid())
  userId                String
  month                 String // Format: YYYY-MM
  formsCreated          Int                 @default(0)
  fieldsGenerated       Int                 @default(0)
  apiCallsMade          Int                 @default(0)
  aiQuestionsGenerated  Int                 @default(0)
  charges               Json // UsageBasedCharge[]
  totalCharges          Int                 @default(0) // in cents
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
  @@index([userId])
  @@index([month])
}

model UsageEvent {
  id         String           @id @default(uuid())
  userId     String
  eventType  UsageEventType
  category   UsageCategory?
  units      UsageUnits?
  resourceId String?
  metadata   Json?
  timestamp  DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventType])
  @@index([timestamp])
}

